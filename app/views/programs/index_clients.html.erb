<div class="container">
  <h1> diet dashboard <%=  %></h1>
  <% data_cal = {} %>
  <% data_cal_ref = {} %>
  <% line_data_cal = [] %>

<!-- plot calories -->
  <% @programs.each do |program| %>
    <%= link_to "See meals", program_meals_path(program) %>
    <% program.meals.group_by(&:start_time).each do |day, meals| %>

      <% data_cal[day.strftime("%d/%m/%Y")] = meals.map{|meal| calorie(meal)}.sum %>
      <% data_cal_ref[day.strftime("%d/%m/%Y")] = program.calorie_target %>

    <% end %>
  <% end %>

  <% data_cal = data_cal.sort_by { |k,_| Date.strptime(k,"%d/%m/%Y") } %>
  <% data_cal_deux = {} %>

  <% data_cal.each do |day,meal| %>
  <% data_cal_deux[day] = meal  %>
  <% end %>

  <% data_cal_ref = data_cal_ref.sort_by { |k,_| Date.strptime(k,"%d/%m/%Y") } %>
  <% data_cal_ref_deux = {} %>

  <% data_cal_ref.each do |day,meal| %>
  <% data_cal_ref_deux[day] = meal  %>
  <% end %>

  <div class = "meal-graph">
    <canvas id="calorie"></canvas>
    <script>
      new Chart(document.getElementById("calorie").getContext("2d"), {
        type:'line',
        data:{
          labels: <%= data_cal_deux.keys.to_json.html_safe %>,
          datasets: [{
            label: "Calories",
            data: <%= data_cal_deux.values.to_json.html_safe %>,
            fill:  false,
            borderColor: 'blue'
            },{
            label: "Goal",
            data: <%= data_cal_ref_deux.values.to_json.html_safe %>,
            fill:  false,
            borderColor: 'red'
          }],
        },
        options: {
          responsive: true,
          title:{
              display: true,
              text:"Chart.js Time Scale"
          },
          scales:{
            xAxes: [{
              type: 'time',
              //
              time: {
              parser: 'DD/MM/YYYY',
              tooltipFormat: 'DD/MM/YYYY',
              unit: 'day',
              unitStepSize: 1,
              displayFormats: {
                'day': 'DD/MM/YYYY'
                }
              },
              ticks: {
                autoSkip: true,
                maxTicksLimit: 20
              }
            }], // XAxes ends
            yAxes: [{
                scaleLabel: {
                  display: true,
                  labelString: 'value'
                }
            }]
          }
        }
    });

</script>

  </div>


<!-- plot macro -->
  <% data_p = {} %>
  <% data_l = {} %>
  <% data_c = {} %>

  <% @programs.each do |program| %>
    <% program.meals.group_by(&:start_time).each do |day, meals| %>

      <% sum_p = 0 %>
      <% sum_c = 0 %>
      <% sum_l = 0 %>
      <% data_p[day.strftime("%d/%m/%Y")] = meals.map{|meal| meal.proteins}.sum %>
      <% data_l[day.strftime("%d/%m/%Y")] = meals.map{|meal| meal.fats}.sum %>
      <% data_c[day.strftime("%d/%m/%Y")] = meals.map{|meal| meal.carbs}.sum  %>
    <% end %>

    <!-- proteins -->
    <% data_p = data_p.sort_by { |k,_| Date.strptime(k,"%d/%m/%Y") } %>
    <% data_p_deux = {} %>

    <% data_p.each do |day,meal| %>
      <% data_p_deux[day] = meal  %>
    <% end %>

    <!-- fats -->
    <% data_l = data_l.sort_by { |k,_| Date.strptime(k,"%d/%m/%Y") } %>
    <% data_l_deux = {} %>

    <% data_l.each do |day,meal| %>
      <% data_l_deux[day] = meal  %>
    <% end %>

    <!-- carbs -->
    <% data_c = data_c.sort_by { |k,_| Date.strptime(k,"%d/%m/%Y") } %>
    <% data_c_deux = {} %>

    <% data_c.each do |day,meal| %>
      <% data_c_deux[day] = meal  %>
    <% end %>

  <div class="macrograph">
    <canvas id = "proteins" > </canvas>
    <canvas id = "carbs"> </canvas>
    <canvas id = "fats" > </canvas>
  </div>

    <script>
     new Chart(document.getElementById("proteins").getContext("2d"), {
        type:'line',
        data:{
          labels: <%= data_p_deux.keys.to_json.html_safe %>,
          datasets: [{
            label: "proteins",
            data: <%= data_p_deux.values.to_json.html_safe %>,
            fill:  false,
            borderColor: 'blue'
            },{
            label: "Goal",
            data: <%= data_p_deux.map { |day,value| [day, program.proteins_target]}.to_h.values %>,
            fill:  false,
            borderColor: 'red'
          }],
        },
        options: {
          responsive: true,
          title:{
              display: true,
              text:"Chart.js Time Scale"
          },
          scales:{
            xAxes: [{
              type: 'time',
              //
              time: {
              parser: 'DD/MM/YYYY',
              tooltipFormat: 'DD/MM/YYYY',
              unit: 'day',
              unitStepSize: 1,
              displayFormats: {
                'day': 'DD/MM/YYYY'
                }
              },
              ticks: {
                autoSkip: true,
                maxTicksLimit: 20
              }
            }], // XAxes ends
            yAxes: [{
                scaleLabel: {
                  display: true,
                  labelString: 'value'
                }
            }]
          }
        }
    });

    new Chart(document.getElementById("carbs").getContext("2d"), {
        type:'line',
        data:{
          labels: <%= data_c_deux.keys.to_json.html_safe %>,
          datasets: [{
            label: "carbs",
            data: <%= data_c_deux.values.to_json.html_safe %>,
            fill:  false,
            borderColor: 'blue'
            },{
            label: "Goal",
            data: <%= data_c_deux.map { |day,value| [day, program.carbs_target]}.to_h.values %>,
            fill:  false,
            borderColor: 'red'
          }],
        },
        options: {
          responsive: true,
          title:{
              display: true,
              text:"Chart.js Time Scale"
          },
          scales:{
            xAxes: [{
              type: 'time',
              //
              time: {
              parser: 'DD/MM/YYYY',
              tooltipFormat: 'DD/MM/YYYY',
              unit: 'day',
              unitStepSize: 1,
              displayFormats: {
                'day': 'DD/MM/YYYY'
                }
              },
              ticks: {
                autoSkip: true,
                maxTicksLimit: 20
              }
            }], // XAxes ends
            yAxes: [{
                scaleLabel: {
                  display: true,
                  labelString: 'value'
                }
            }]
          }
        }
    });

    new Chart(document.getElementById("fats").getContext("2d"), {
        type:'line',
        data:{
          labels: <%= data_l_deux.keys.to_json.html_safe %>,
          datasets: [{
            label: "fats",
            data: <%= data_l_deux.values.to_json.html_safe %>,
            fill:  false,
            borderColor: 'blue'
            },{
            label: "Goal",
            data: <%= data_l_deux.map { |day,value| [day, program.fats_target]}.to_h.values %>,
            fill:  false,
            borderColor: 'red'
          }],
        },
        options: {
          responsive: true,
          title:{
              display: true,
              text:"Chart.js Time Scale"
          },
          scales:{
            xAxes: [{
              type: 'time',
              //
              time: {
              parser: 'DD/MM/YYYY',
              tooltipFormat: 'DD/MM/YYYY',
              unit: 'day',
              unitStepSize: 1,
              displayFormats: {
                'day': 'DD/MM/YYYY'
                }
              },
              ticks: {
                autoSkip: true,
                maxTicksLimit: 20
              }
            }], // XAxes ends
            yAxes: [{
                scaleLabel: {
                  display: true,
                  labelString: 'value'
                }
            }]
          }
        }
    });
    </script>

  <% end %>





























<!-- Table -->

  <% @programs.each do |program| %>
    <% sum_p = sum_c =sum_l = sum_c = sum_cal = 0 %>
        <table class = "nutri-table-meal">
            <thead>
              <tr>
                <th > Date </th>
                <th > Protein</th>
                <th > Fats</th>
                <th > Carbs</th>
                <th > Calories</th>
              </tr>
            </thead>
          <tbody>
          <% program.meals.group_by(&:start_time).each do |day, meals| %>
          <% col_protein = pickcolor(meals.map{|meal| meal.proteins}.sum(), program.proteins_target) %>
          <% col_fats = pickcolor(meals.map{|meal| meal.fats}.sum(), program.fats_target) %>
          <% col_carbs = pickcolor(meals.map{|meal| meal.carbs}.sum(), program.carbs_target) %>
          <% col_calorie = pickcolor(meals.map{|meal| calorie(meal)}.sum(), program.calorie_target) %>
            <tr>
              <td> <%= link_to meals.last.start_time.strftime("%d/%m/%Y"), program_meals_path(program, date:meals.last.start_time) %>  </td>
              <td style="background-color: <%= col_protein %>" > <%= meals.map{|meal| meal.proteins}.sum() %> </td>
              <td style="background-color: <%= col_fats %>" > <%= meals.map{|meal| meal.fats}.sum() %> </td>
              <td style="background-color: <%= col_carbs %>" > <%= meals.map{|meal| meal.carbs}.sum() %> </td>
              <td style="background-color: <%= col_calorie %>" > <%= meals.map{|meal| calorie(meal)}.sum() %> </td>
              <% sum_p = sum_c =sum_l = sum_c = sum_cal = 0 %>
            </tr>
          <% end %>
        </tbody>
      </table>
  <% end %>

</div>
