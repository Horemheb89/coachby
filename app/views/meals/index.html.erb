

<div class="container">
  <h1 class = page-title> Meal plan <i class="fas fa-utensils"></i> </h1>



    <%= week_calendar number_of_weeks: 1, events: @meals do |date, meals| %>
      <div class = "date">
        <span class = "datedays"> <%= link_to date.strftime("%d/%m"), program_meals_path(@program, date: date) %> </span>
      </div>
      <div class = "meal-list">
        <% meals.each do |meal| %>
          <ul>
            <li> <%= link_to meal.name.capitalize, program_meal_path(@program, meal) %> </li>
          </ul>
        <% end %>
      </div>
    <% end %>

    <div class="macro_card">
      <div class = "macro">
        <h2> <%=   @meals_date.map { |meal| meal.proteins}.sum() %> <span style="color:gray";> g </span></h2>
        <p> <i class="fas fa-drumstick-bite"></i>  Protein </p>
        <% ratio_prot = (@meals_date.map { |meal| meal.proteins}.sum())/@program.proteins_target.to_f %>
        <div id = "protein-bar" data-macro= <%= ratio_prot > 1 ? 1 : ratio_prot %> ></div>
        <div>
          <p style="color: <%= "red" if ratio_prot > 1.2 %>;font-weight: <%= "bold" if ratio_prot > 1.2 %>;" > <%= (@meals_date.map { |meal| meal.proteins}.sum()) %> </p>/ <p> <%= @program.proteins_target %> </p>
        </div>
      </div>
      <div class = "macro">
        <h2> <%=   @meals_date.map { |meal| meal.fats}.sum() %> g</h2>
        <p> <i class="fas fa-cheese"></i> Fats </p>
        <% ratio_fat = (@meals_date.map { |meal| meal.fats}.sum())/@program.fats_target.to_f %>
        <div id = "fat-bar" data-macro= <%= ratio_fat > 1 ? 1 : ratio_fat %> ></div>
        <div>
          <p style="color: <%= "red" if ratio_fat > 1.2 %>;font-weight: <%= "bold" if ratio_fat > 1.2 %>;" > <%= (@meals_date.map { |meal| meal.fats}.sum()) %> </p>/ <p> <%= @program.proteins_target %> </p>
        </div>
      </div>

      <div class = "macro">
        <h2> <%=   @meals_date.map { |meal| meal.carbs}.sum() %> g</h2>
        <p> <i class="fas fa-bread-slice"></i> Carbs </p>
        <% ratio_carb = (@meals_date.map { |meal| meal.carbs}.sum())/@program.carbs_target.to_f %>
        <div id = "carb-bar" data-macro= <%= ratio_carb > 1 ? 1 : ratio_carb %> ></div>
        <div>
          <p style="color: <%= "red" if ratio_carb > 1.2 %>;font-weight: <%= "bold" if ratio_carb > 1.2 %>;" > <%= (@meals_date.map { |meal| meal.carbs}.sum()) %> </p>/ <p> <%= @program.carbs_target %> </p>
        </div>
      </div>
      <div class = "macro">
        <h2> <%=   @meals_date.map { |meal| calorie(meal)}.sum() %> </h2>
        <p> <i class="fas fa-burn"></i> Calories </p>
        <% ratio_cal = (@meals_date.map { |meal|calorie(meal)}.sum())/@program.calorie_target.to_f %>
        <div id = "carb-cal" data-macro= <%= ratio_cal > 1 ? 1 : ratio_cal %> ></div>
        <div>
          <p style="color: <%= "red" if ratio_cal > 1.2 %>;font-weight: <%= "bold" if ratio_cal > 1.2 %>;" > <%= (@meals_date.map { |meal| calorie(meal)}.sum()) %> </p>/ <p> <%= @program.calorie_target %> </p>
        </div>
      </div>
    </div>

    <%= render "form", meal: @meal %>


  <% @meals_date.each do |meal| %>
    <div class = meal>
      <div>
        <h3> <%=  link_to meal.name.capitalize(),program_meal_path(meal.program_id,meal) %> </h3>
        <span> <%= (meal.start_time.strftime("%m/%d/%Y")) %></span>
      </div>
      <div class = "meal-stat">
        <div class = "nutri-table">
          <table>
            <thead>
                <tr>
                  <th > Ingredient</th>
                  <th > Quantity</th>
                  <th style="background-color: rgba(251, 19, 0, 0.4) ;border-radius: 25px"> Proteins</th>
                  <th style="background-color: rgba(251, 240, 0, 0.4);border-radius: 25px"> Fats</th>
                  <th style="background-color: rgba(0, 221, 251, 0.4);border-radius: 25px"> Carbs</th>
                  <th style="background-color: rgba(186, 0, 251,0.4);border-radius: 25px" > Calories</th>
                </tr>
            </thead>
            <tbody>
              <% sum_p = sum_c =sum_l = sum_c = sum_cal = 0 %>
              <% meal.doses.each do |dose| %>
                <tr>
                  <td> <%= link_to dose.ingredient.name, ingredient_path(dose.ingredient) %> </td>
                  <td> <%= dose.quantity %> </td>
                  <td> <%= ((dose.quantity * dose.ingredient.proteins)/100).round   %> </td>
                  <td> <%= ((dose.quantity * dose.ingredient.fats)/100).round  %> </td>
                  <td> <%= ((dose.quantity * dose.ingredient.carbs)/100).round  %> </td>

                  <td> <%= (((dose.quantity * dose.ingredient.proteins)/100)*4 +
                  ((dose.quantity * dose.ingredient.fats)/100) * 9 +
                  ((dose.quantity * dose.ingredient.carbs)*4)/100) %> </td>

                  <% sum_cal += (((dose.quantity * dose.ingredient.proteins)/100) * 4 +
                                ((dose.quantity * dose.ingredient.fats)/100) * 9 +
                                ((dose.quantity * dose.ingredient.carbs)/100) * 4)  %>
                </tr>
                <% if meal.doses.last == dose %>
                    <tr>
                      <td> Totaux:  </td>
                      <td> <%=  %> </td>
                      <td style="background-color: rgba(251, 19, 0, 0.4) ;border-radius: 25px"> <%= meal.proteins %> </td>
                      <td style="background-color: rgba(251, 240, 0, 0.4) ;border-radius: 25px"> <%= meal.fats %> </td>
                      <td style="background-color: rgba(0, 221, 251, 0.4) ;border-radius: 25px"> <%= meal.carbs %> </td>
                      <td style="background-color: rgba(186, 0, 251,0.4) ;border-radius: 25px"> <%= sum_cal %> </td>
                      <% sum_p = sum_c =sum_l = sum_c = sum_cal = 0 %>
                    </tr>
                  <% end %>
              <% end %>
            </tbody>
        </table>
          <%= render "doses/form", meal: meal, dose: @dose %>
      </div>
      <div class = "graph">
        <canvas id= "<%= "myChart#{meal.name}"%>" width="600" height="600"></canvas>
        <script>
            new Chart(document.getElementById("<%= "myChart#{meal.name}"%>").getContext('2d'), {
              type: 'bar',
              data: {
                  labels: [""],
                  datasets: [{
                      label: "Proteins",
                      data: <%= [meal.proteins] %>,
                      backgroundColor: [
                          'rgba(251, 19, 0, 0.6)'
                      ],
                      borderColor: [
                          'rgba(255, 99, 132, 1)'
                      ],
                      borderWidth: 1
                  },{
                      label: "Fats",
                      data: <%= [meal.fats] %>,
                      backgroundColor: [
                          'rgba(251, 240, 0, 0.6)'
                      ],
                      borderColor: [
                          'rgba(255, 206, 86, 1)'
                      ],
                      borderWidth: 1
                  },{
                      label: "Carbs",
                      data: <%= [meal.carbs] %>,
                      backgroundColor: [
                          'rgba(0, 221, 251, 0.6)'
                      ],
                      borderColor: [
                          'rgba(54, 162, 235, 0.6)'
                      ],
                      borderWidth: 1
                  }]
              },
              options: {
                title: {
                display: true,
                position: 'top',
                text: 'Macro',
                padding: 20,
                },
                legend: {
                  display: true,
                  position:'bottom',
                  labels: {
                      fontColor: 'black'
                  }
                },
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                  }
                }
            });
        </script>

       <!--  <canvas id= "<%= "myChartcal#{meal.name}" %>"  ></canvas>
        <script>
            new Chart(document.getElementById("<%= "myChartcal#{meal.name}"%>").getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ["calorie"],
                    datasets: [{
                        label: "calorie",
                        data: <%= [calorie(meal)] %>,
                        backgroundColor: [
                            'rgba(151, 0, 0, 0.6)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    }
                }
            });
        </script> -->
   <!--      <% unless meal.doses.empty?  %>
          <%= column_chart macro_char(meal), ytitle: "Masse (Gr)", min: 0, max: macro_max(meal) + 40, colors: ["#EF4B2A"] %>
        <% end %> -->
      </div>
    </div>
  </div>
  <% end %>


  <% @meals_date.map do |meal| %>
    <% if meal.name.downcase ==  "petit-dejeuner" %>
      <% @meal_type["petit-dejeuner"] += calorie(meal) %>
    <% elsif meal.name.downcase == "dejeuner" %>
      <% @meal_type["dejeuner"] += calorie(meal) %>
    <% elsif meal.name.downcase == "gouter" %>
      <% @meal_type["gouter"] += calorie(meal) %>
    <% elsif meal.name.downcase == "diner" %>
      <% @meal_type["diner"] += calorie(meal) %>
    <% end %>
  <% end %>

<canvas id= "week"></canvas>
        <script>
            new Chart(document.getElementById("week").getContext('2d'), {
                type: 'horizontalBar',
                data: {
                    labels: <%= @meal_type_labels.to_json.html_safe %>,
                    datasets: [{
                        label: "Calories",
                        data: <%= @meal_type.values %>,
                        backgroundColor: [
                            'rgba(251, 19, 0, 0.6)',
                            'rgba(251, 240, 0, 0.6)',
                            'rgba(0, 221, 251, 0.6)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(54, 162, 235, 0.6)',
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                  legend: {
                    display: true,
                    position: 'bottom',
                    labels: {
                      fontColor: 'rgb(255, 99, 132)'
                    }
                  },
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    }
                }
            });
        </script>


</div>


